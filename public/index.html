<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbeitszeit Statistik</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --hover: #2c2c2c;
            --text: #e0e0e0;
            --accent: #4caf50;
            --muted: #888;
            --border: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1000px; margin: 0 auto; }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { margin: 0; font-size: 1.5rem; }

        .controls { display: flex; gap: 10px; }

        button {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover { background: var(--hover); }
        button.primary { background: var(--accent); color: #000; border: none; font-weight: bold; }

        /* Stats Grid (jetzt nur 3) */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .stat-label { font-size: 0.9rem; color: var(--muted); display: block; margin-bottom: 5px; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: var(--accent); }

        /* Chart */
        .chart-container {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            height: 300px;
        }

        /* Tabelle */
        .table-container {
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid var(--border); }
        th { color: var(--muted); font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
        
        /* Klickbare Zeilen */
        tbody tr.main-row { cursor: pointer; transition: background 0.1s; }
        tbody tr.main-row:hover { background: var(--hover); }
        tbody tr.main-row.active { background: var(--hover); border-bottom: none; }
        
        /* Details (versteckt) */
        tr.details-row { display: none; background: #181818; }
        tr.details-row.show { display: table-row; }
        tr.details-row td { border-bottom: 1px solid var(--border); padding: 0; }

        .detail-content {
            padding: 20px;
            color: #bbb;
            font-size: 0.95rem;
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }
        
        .detail-group h4 { margin: 0 0 10px 0; font-size: 0.85rem; color: var(--muted); }
        .detail-list { list-style: none; padding: 0; margin: 0; }
        .detail-list li { margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        
        .arrow { display: inline-block; transition: transform 0.2s; margin-right: 8px; color: var(--muted); }
        tr.main-row.active .arrow { transform: rotate(90deg); color: var(--text); }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 id="monthTitle">Lade Daten...</h1>
            <div class="controls">
                <button onclick="changeMonth(-1)">◀</button>
                <button onclick="changeMonth(1)">▶</button>
                <button onclick="jumpToToday()">Heute</button>
                <button class="primary" onclick="exportCSV()">Export CSV</button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="card">
                <span class="stat-label">Gesamt Arbeitszeit</span>
                <span class="stat-value" id="totalWork">0h 00m</span>
            </div>
            <div class="card">
                <span class="stat-label">Durchschnitt Pause</span>
                <span class="stat-value" id="avgBreak" style="color: #e0e0e0">0 min</span>
            </div>
            <div class="card">
                <span class="stat-label">Tage anwesend</span>
                <span class="stat-value" id="daysCount" style="color: #e0e0e0">0</span>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="workChart"></canvas>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Start</th>
                        <th>Ende</th>
                        <th>Pause (Gesamt)</th>
                        <th>Arbeitszeit</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // State
        let currentDate = new Date();
        let currentData = [];
        let myChart = null;

        document.addEventListener('DOMContentLoaded', loadMonth);

        // --- Navigation ---
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            loadMonth();
        }

        function jumpToToday() {
            currentDate = new Date();
            loadMonth();
        }

        // --- Daten laden ---
        async function loadMonth() {
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            
            // Titel
            document.getElementById('monthTitle').innerText = 
                currentDate.toLocaleString('de-DE', { month: 'long', year: 'numeric' });

            try {
                const res = await fetch(`/api/month?year=${year}&month=${month}`);
                const data = await res.json();
                currentData = data;
                renderDashboard(data);
            } catch (err) {
                console.error(err);
            }
        }

        // --- Rendern ---
        function renderDashboard(data) {
            let totalMin = 0;
            let totalBreak = 0;
            const labels = [];
            const values = [];
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#666;">Keine Daten für diesen Monat</td></tr>';
            }

            data.forEach((entry, index) => {
                totalMin += entry.arbeitszeit_min;
                totalBreak += entry.pausen_min;

                const dateObj = new Date(entry.datum);
                const dayStr = dateObj.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', weekday: 'short' });
                
                labels.push(dateObj.getDate() + '.'); 
                values.push(entry.arbeitszeit_min / 60);

                // Zeile erstellen
                // Wir geben der Zeile eine ID basierend auf dem Datum, damit wir sie finden
                const rowId = `row-${entry.datum}`;
                const detailId = `detail-${entry.datum}`;

                const tr = document.createElement('tr');
                tr.className = 'main-row';
                tr.onclick = () => toggleDetails(entry.datum, tr, detailId);
                tr.innerHTML = `
                    <td><span class="arrow">▶</span> ${dayStr}</td>
                    <td>${formatTimeISO(entry.start)}</td>
                    <td>${formatTimeISO(entry.ende)}</td>
                    <td>${entry.pausen_min} min</td>
                    <td style="color:var(--accent); font-weight:bold">${formatMinutes(entry.arbeitszeit_min)}</td>
                `;
                tbody.appendChild(tr);

                // Versteckte Detail-Zeile erstellen
                const detailTr = document.createElement('tr');
                detailTr.id = detailId;
                detailTr.className = 'details-row';
                detailTr.innerHTML = `
                    <td colspan="5">
                        <div class="detail-content" id="content-${entry.datum}">
                            <span style="color:#666;">Lade Details...</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(detailTr);
            });

            // Stats Update
            document.getElementById('totalWork').innerText = formatMinutes(totalMin);
            document.getElementById('daysCount').innerText = data.length;
            const avg = data.length ? Math.round(totalBreak / data.length) : 0;
            document.getElementById('avgBreak').innerText = avg + " min";

            renderChart(labels, values);
        }

        // --- Details Nachladen ---
        async function toggleDetails(dateString, mainRow, detailRowId) {
            const detailRow = document.getElementById(detailRowId);
            const contentDiv = document.getElementById(`content-${dateString}`);
            
            // Auf/Zu klappen
            const isClosed = !detailRow.classList.contains('show');
            
            // Alle anderen schließen (optional, wirkt ruhiger)
            document.querySelectorAll('.details-row').forEach(r => r.classList.remove('show'));
            document.querySelectorAll('.main-row').forEach(r => r.classList.remove('active'));

            if (isClosed) {
                detailRow.classList.add('show');
                mainRow.classList.add('active');

                // Daten holen, falls noch nicht da
                if (!contentDiv.dataset.loaded) {
                    try {
                        const res = await fetch(`/api/get?date=${dateString}`);
                        if (!res.ok) throw new Error('Keine Details');
                        const json = await res.json();
                        
                        // HTML bauen für die Details
                        let breaksHtml = '<span style="color:#666">Keine Pausen erfasst</span>';
                        if (json.breaks && json.breaks.length > 0) {
                            breaksHtml = '<ul class="detail-list">' + 
                                json.breaks.map(b => `<li>☕ ${b.start} - ${b.end}</li>`).join('') + 
                                '</ul>';
                        }

                        contentDiv.innerHTML = `
                            <div class="detail-group">
                                <h4>PAUSENZEITEN</h4>
                                ${breaksHtml}
                            </div>
                            <div class="detail-group">
                                <h4>ZEITRAUM</h4>
                                <div style="color:var(--text)">${json.work_start} bis ${json.work_end}</div>
                            </div>
                        `;
                        contentDiv.dataset.loaded = "true";
                    } catch (e) {
                        contentDiv.innerHTML = "Konnte Details nicht laden.";
                    }
                }
            }
        }

        // --- Chart ---
        function renderChart(labels, dataWork) {
            const ctx = document.getElementById('workChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stunden',
                        data: dataWork,
                        backgroundColor: '#4caf50',
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#333' },
                            ticks: { color: '#888' } 
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#888' } 
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Helper ---
        function formatMinutes(mins) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h}h ${String(m).padStart(2, '0')}m`;
        }

        function formatTimeISO(isoStr) {
            if(!isoStr) return "-";
            return new Date(isoStr).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }

        function exportCSV() {
            if (!currentData.length) return alert("Nichts zum Exportieren da.");
            let csv = "Datum;Wochentag;Start;Ende;Pause (Min);Arbeitszeit (Min);Stunden\n";
            currentData.forEach(row => {
                const d = new Date(row.datum);
                const tag = d.toLocaleDateString('de-DE', { weekday: 'long' });
                const hours = (row.arbeitszeit_min / 60).toFixed(2).replace('.', ','); 
                csv += `${row.datum};${tag};${formatTimeISO(row.start)};${formatTimeISO(row.ende)};${row.pausen_min};${row.arbeitszeit_min};${hours}\n`;
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `Arbeitszeit_${currentDate.toISOString().slice(0,7)}.csv`;
            link.click();
        }
    </script>
</body>
</html>
