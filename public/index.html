<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbeitszeit Statistik</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --hover: #2c2c2c;
            --text: #e0e0e0;
            --accent: #4caf50;
            --muted: #888;
            --border: #333;
            --drawer-bg: #1a1a1a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            overflow-x: hidden; /* Wichtig fÃ¼r den Drawer */
        }

        .container { max-width: 1000px; margin: 0 auto; transition: opacity 0.3s; }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { margin: 0; font-size: 1.5rem; }

        .controls { display: flex; gap: 10px; }

        button {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover { background: var(--hover); }
        button.primary { background: var(--accent); color: #000; border: none; font-weight: bold; }

        /* Drawer (Logbuch) */
        .drawer-backdrop {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5);
            z-index: 998;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .drawer-backdrop.open { display: block; opacity: 1; }

        .drawer {
            position: fixed; top: 0; right: 0;
            width: 300px; height: 100%;
            background: var(--drawer-bg);
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid var(--border);
        }
        .drawer.open { transform: translateX(0); }

        .drawer h2 { margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; }
        
        .log-list { list-style: none; padding: 0; margin: 0; }
        .log-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }
        .log-item:last-child { border-bottom: none; }
        
        .log-status { font-weight: bold; font-size: 0.9rem; }
        .log-status.KOMMEN { color: var(--accent); }
        .log-status.GEHEN { color: #f44336; }
        .log-time { font-size: 0.85rem; color: var(--muted); }
        .log-date { font-size: 0.7rem; color: #555; display: block; }


        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .stat-label { font-size: 0.9rem; color: var(--muted); display: block; margin-bottom: 5px; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: var(--accent); }

        /* Chart & Table */
        .chart-container {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            height: 300px;
        }
        .table-container { background: var(--card); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid var(--border); }
        th { color: var(--muted); font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
        tbody tr.main-row { cursor: pointer; transition: background 0.1s; }
        tbody tr.main-row:hover { background: var(--hover); }
        tr.details-row { display: none; background: #181818; }
        tr.details-row.show { display: table-row; }
        .detail-content { padding: 20px; color: #bbb; display: flex; gap: 40px; }
        .detail-list { list-style: none; padding: 0; }

    </style>
</head>
<body>

    <div class="drawer-backdrop" id="drawerBackdrop" onclick="toggleDrawer()"></div>

    <div class="drawer" id="logDrawer">
        <h2>Letzte 10 Buchungen</h2>
        <div id="logContent">Lade...</div>
    </div>

    <div class="container">
        <header>
            <h1 id="monthTitle">Lade Daten...</h1>
            <div class="controls">
                <button onclick="toggleDrawer()">ðŸ“‹ Logbuch</button>
                <span style="width: 10px; display:inline-block"></span> <button onclick="changeMonth(-1)">â—€</button>
                <button onclick="changeMonth(1)">â–¶</button>
                <button onclick="jumpToToday()">Heute</button>
                <button class="primary" onclick="exportCSV()">Export CSV</button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="card">
                <span class="stat-label">Gesamt Arbeitszeit</span>
                <span class="stat-value" id="totalWork">0h 00m</span>
            </div>
            <div class="card">
                <span class="stat-label">Durchschnitt Pause</span>
                <span class="stat-value" id="avgBreak" style="color: #e0e0e0">0 min</span>
            </div>
            <div class="card">
                <span class="stat-label">Tage anwesend</span>
                <span class="stat-value" id="daysCount" style="color: #e0e0e0">0</span>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="workChart"></canvas>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Start</th>
                        <th>Ende</th>
                        <th>Pause (Gesamt)</th>
                        <th>Arbeitszeit</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let currentData = [];
        let myChart = null;

        document.addEventListener('DOMContentLoaded', loadMonth);

        // --- DRAWER LOGIC ---
        async function toggleDrawer() {
            const drawer = document.getElementById('logDrawer');
            const backdrop = document.getElementById('drawerBackdrop');
            const content = document.getElementById('logContent');
            
            // Toggle Klassen
            const isOpen = drawer.classList.contains('open');
            
            if (isOpen) {
                // SchlieÃŸen
                drawer.classList.remove('open');
                backdrop.classList.remove('open');
            } else {
                // Ã–ffnen
                drawer.classList.add('open');
                backdrop.classList.add('open');
                
                // Daten laden
                content.innerHTML = '<p style="color:#888">Lade Echtzeit-Daten...</p>';
                try {
                    const res = await fetch('/api/recent');
                    const logs = await res.json();
                    
                    if(logs.length === 0) {
                        content.innerHTML = '<p>Keine EintrÃ¤ge gefunden.</p>';
                        return;
                    }

                    let html = '<ul class="log-list">';
                    logs.forEach(log => {
                        const dateObj = new Date(log.time);
                        // Format: 10:30 Uhr
                        const timeStr = dateObj.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'});
                        // Format: Mo, 02.02.
                        const dateStr = dateObj.toLocaleDateString('de-DE', {weekday: 'short', day: '2-digit', month: '2-digit'});
                        
                        html += `
                            <li class="log-item">
                                <div>
                                    <span class="log-status ${log.status}">${log.status}</span>
                                    <span class="log-date">${dateStr}</span>
                                </div>
                                <span class="log-time">${timeStr}</span>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    content.innerHTML = html;

                } catch (e) {
                    content.innerHTML = '<p style="color:red">Fehler beim Laden.</p>';
                }
            }
        }

        // --- RESTLICHE LOGIK (Month View) ---

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            loadMonth();
        }

        function jumpToToday() {
            currentDate = new Date();
            loadMonth();
        }

        async function loadMonth() {
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            document.getElementById('monthTitle').innerText = currentDate.toLocaleString('de-DE', { month: 'long', year: 'numeric' });

            try {
                const res = await fetch(`/api/month?year=${year}&month=${month}`);
                const data = await res.json();
                currentData = data;
                renderDashboard(data);
            } catch (err) { console.error(err); }
        }

        function renderDashboard(data) {
            let totalMin = 0;
            let totalBreak = 0;
            const labels = [];
            const values = [];
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if(data.length === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#666;">Keine Daten</td></tr>';

            data.forEach(entry => {
                totalMin += entry.arbeitszeit_min;
                totalBreak += entry.pausen_min;
                const dateObj = new Date(entry.datum);
                const dayStr = dateObj.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', weekday: 'short' });
                
                labels.push(dateObj.getDate() + '.'); 
                values.push(entry.arbeitszeit_min / 60);

                const rowId = `row-${entry.datum}`;
                const detailId = `detail-${entry.datum}`;

                const tr = document.createElement('tr');
                tr.className = 'main-row';
                tr.onclick = () => toggleDetails(entry.datum, tr, detailId);
                tr.innerHTML = `
                    <td>${dayStr}</td>
                    <td>${formatTimeISO(entry.start)}</td>
                    <td>${formatTimeISO(entry.ende)}</td>
                    <td>${entry.pausen_min} min</td>
                    <td style="color:var(--accent); font-weight:bold">${formatMinutes(entry.arbeitszeit_min)}</td>
                `;
                tbody.appendChild(tr);

                const detailTr = document.createElement('tr');
                detailTr.id = detailId;
                detailTr.className = 'details-row';
                detailTr.innerHTML = `<td colspan="5"><div class="detail-content" id="content-${entry.datum}"><span style="color:#666;">Lade...</span></div></td>`;
                tbody.appendChild(detailTr);
            });

            document.getElementById('totalWork').innerText = formatMinutes(totalMin);
            document.getElementById('daysCount').innerText = data.length;
            document.getElementById('avgBreak').innerText = (data.length ? Math.round(totalBreak / data.length) : 0) + " min";

            renderChart(labels, values);
        }

        async function toggleDetails(dateString, mainRow, detailRowId) {
            const detailRow = document.getElementById(detailRowId);
            const contentDiv = document.getElementById(`content-${dateString}`);
            const isClosed = !detailRow.classList.contains('show');
            
            document.querySelectorAll('.details-row').forEach(r => r.classList.remove('show'));
            if (isClosed) {
                detailRow.classList.add('show');
                if (!contentDiv.dataset.loaded) {
                    try {
                        const res = await fetch(`/api/get?date=${dateString}`);
                        if (!res.ok) throw new Error('Err');
                        const json = await res.json();
                        let breaksHtml = 'Keine Pausen';
                        if (json.breaks && json.breaks.length > 0) {
                            breaksHtml = '<ul class="detail-list">' + json.breaks.map(b => `<li>â˜• ${b.start} - ${b.end}</li>`).join('') + '</ul>';
                        }
                        contentDiv.innerHTML = `<div><h4 style="margin:0 0 10px 0; color:#888">PAUSEN</h4>${breaksHtml}</div><div><h4 style="margin:0 0 10px 0; color:#888">ZEITRAUM</h4>${json.work_start} - ${json.work_end}</div>`;
                        contentDiv.dataset.loaded = "true";
                    } catch (e) { contentDiv.innerHTML = "Fehler."; }
                }
            }
        }

        function renderChart(labels, dataWork) {
            const ctx = document.getElementById('workChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Stunden', data: dataWork, backgroundColor: '#4caf50', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#333' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function formatMinutes(mins) { return `${Math.floor(mins / 60)}h ${String(mins % 60).padStart(2, '0')}m`; }
        function formatTimeISO(isoStr) { return isoStr ? new Date(isoStr).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : "-"; }
        function exportCSV() { /* CSV Logic (gleich wie vorher) */ alert("Export Funktion hier..."); } 
    </script>
</body>
</html>
